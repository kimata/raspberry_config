#!/usr/bin/env zsh
# Generated by Ansible for {{ ansible_hostname  }}

zmodload zsh/regex

COUNT=6

function get_gateway_ip {
    for ((i=0; i < 5; i++)); do
        ip=$(/sbin/ip route 2> /dev/null | awk '/default via / { print $3 }');
	if [[ "$ip" -regex-match "^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$" ]]; then
            echo $ip
            return
        fi
        /sbin/wpa_cli -i wlan0 reconfigure > /dev/null 2>&1
        sleep 10
    done
}

gateway_ip=$(get_gateway_ip)

if [ "$gateway_ip" = "" ]; then
    echo "unable to get gateway IP." >&2
    exit
fi

ping=$(ping -c $COUNT -q ${gateway_ip} 2> /dev/null)
count=$(echo $ping | grep 'received' | awk -F',' '{ print $2 }' | awk '{ print $1 }')

if [ "$count" = "0" ]; then
    echo "Connectivity test failed (IP: ${gateway_ip})." >&2
    echo "Let's try to reconnect to WiFi AP." >&2

    echo "ping RESULT:" >&2
    echo "$ping" >&2

    arp=$(/usr/sbin/arp)
    echo "arp RESULT:" >&2
    echo "$arp" >&2

    iwconfig=$(sudo iwconfig)
    echo "iwconfig RESULT:" >&2
    echo "$iwconfig" >&2
else
    echo "Connectivity test passed. Packet(s) received: ${count}."
fi
